
# 部署计划书 — MicroForum

## 一、部署目标
- 在本地通过 Docker Compose 一键启动 MySQL 与 Tomcat（包含 JSP 支持）
- 应用以 WAR 形式部署（包含 JSP），Tomcat 提供 JSP 渲染
- 数据与上传文件持久化到宿主机（便于备份）
- 局域网可访问：访问地址 `http://<host-ip>:8080/`

## 二、前置条件
- 已安装 Docker 与 Docker Compose（Docker Desktop）
- 已安装 JDK & Maven（用于本地构建 WAR）
- 本机有可用端口 8080、3306

## 三、构建 WAR（完整步骤）
1. 在 IDEA 中完成代码，确保 `web.xml`, `WEB-INF/jsp/` 等文件已放置。
2. 在项目根目录执行：
   - `mvn clean package -DskipTests`（生成 `target/microforum.war`）
3. 验证 WAR 中包含 JSP（在 `target/microforum/WEB-INF/jsp` 可见）

## 四、Tomcat Dockerfile（支持 JSP）
- Tomcat 官方镜像已支持 JSP，以下 Dockerfile 把 WAR 放入 webapps：
```dockerfile
FROM tomcat:9.0-jdk11
LABEL maintainer="microforum@example.com"
# 清空默认 webapps（可选）
RUN rm -rf /usr/local/tomcat/webapps/*
# 复制 WAR
COPY target/microforum.war /usr/local/tomcat/webapps/ROOT.war
# 创建 uploads 目录并暴露为卷
RUN mkdir -p /data/uploads
VOLUME ["/data/uploads"]
EXPOSE 8080
```

## 五、docker-compose.yml（详细）
```yaml
version: '3.8'
services:
  mysql:
    image: mysql:8.0
    container_name: microforum_mysql
    environment:
      MYSQL_ROOT_PASSWORD: root_password
      MYSQL_DATABASE: microforum
      MYSQL_USER: micro_user
      MYSQL_PASSWORD: secure_password
    volumes:
      - ./docker/mysql_data:/var/lib/mysql
    ports:
      - "3306:3306"
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - micro_net

  web:
    build: .
    container_name: microforum_tomcat
    depends_on:
      mysql:
        condition: service_healthy
    environment:
      FILE_STORAGE_PATH: /data/uploads
      DB_URL: jdbc:mysql://mysql:3306/microforum?useSSL=false&serverTimezone=UTC
      DB_USER: micro_user
      DB_PASSWORD: secure_password
    volumes:
      - ./uploads:/data/uploads         # 持久化上传文件到宿主 ./uploads
      - ./logs/tomcat:/usr/local/tomcat/logs
    ports:
      - "8080:8080"
    networks:
      - micro_net

networks:
  micro_net:
    driver: bridge
```

> 注意：`./uploads`、`./docker/mysql_data` 与 `./logs/tomcat` 需要先创建并设置合适权限（`chmod 775`），以保证容器内 Tomcat 有写入权限。

## 六、Tomcat JNDI DataSource（在 docker 镜像或 Host Tomcat）
- 若使用容器的 Tomcat，推荐使用应用内 `AppContextListener` 用 HikariCP 初始化 DataSource（更容易控制），或者在 `$CATALINA_BASE/conf/context.xml` 配置 Resource（需要改镜像或在宿主挂载 conf 修改）：
```xml
<Resource name="jdbc/microforum" auth="Container" type="javax.sql.DataSource"
    maxTotal="20" maxIdle="10" maxWaitMillis="10000"
    username="micro_user" password="secure_password" driverClassName="com.mysql.cj.jdbc.Driver"
    url="jdbc:mysql://mysql:3306/microforum?useSSL=false&serverTimezone=UTC"/>
```

## 七、启动流程（逐步并带命令）
1. 在宿主机项目根目录准备好：
   - `target/microforum.war`（或在 compose build 中子镜像构建）
   - `docker-compose.yml`
   - 创建持久化目录：`mkdir -p ./uploads ./docker/mysql_data ./logs/tomcat`
   - 赋权：`chmod -R 775 ./uploads ./docker/mysql_data ./logs/tomcat`
2. 执行构建并启动：
   - `docker-compose up --build -d`
3. 查看容器状态：
   - `docker ps`
   - `docker-compose logs -f mysql` / `docker-compose logs -f web`
4. 初始 DB 建表（两种方式）：
   - 手动：`docker exec -it microforum_mysql mysql -u root -p` 然后运行建表 SQL
   - 自动：在应用第一次启动时，AppContextListener 检测 DB 并执行 `schema.sql`（将 schema.sql 放入 classpath 并实现自动执行）
5. 访问应用：`http://<host-ip>:8080/`（若 WAR 名为 ROOT）
6. 检查 uploads：上传文件后，宿主 `./uploads` 会有对应文件

## 八、文件权限与 SELinux（Linux 主机注意）
- 若宿主使用 SELinux，需 `chcon -Rt svirt_sandbox_file_t ./uploads`
- 若遇权限问题，`docker-compose exec web bash`，检查 `/data/uploads` 权限并修复：`chown -R 1000:1000 /data/uploads`（1000 为 container tomcat 用户 id，按需调整）

## 九、端口与局域网访问
- 确保宿主防火墙允许 8080 访问（例如 `ufw allow 8080/tcp`）
- 局域网访问 URL：`http://<host-ip>:8080/`，host-ip 为宿主 IP（`ip addr` 可查）

## 十、持久化备份策略
- MySQL：定期 `docker exec microforum_mysql sh -c 'exec mysqldump -u root -p"$MYSQL_ROOT_PASSWORD" microforum' > microforum_backup.sql`
- 上传文件：定期 `rsync -a ./uploads /backup/path/`

## 十一、排错清单
- **无法连接 MySQL**：检查 container logs、network、DB_URL 是否正确（使用服务名 mysql）
- **JSP 错误/404**：确认 WAR 包内 `WEB-INF/jsp` 存在且 Tomcat 运行用户有读取权限
- **上传失败**：确认 `uploads` 目录权限以及 `upload.maxFileSize` 配置
- **端口被占用**：更改 `docker-compose.yml` 的端口映射如 `"8081:8080"`

## 十二、上线后建议（扩展）
- 使用 Nginx 做反向代理，处理静态资源，加 TLS，并作为缓存层
- 将文件存储迁移至对象存储（S3）并把 uploads 卷改为外部服务
- 使用 CI/CD 构建镜像并推送私有 Registry

