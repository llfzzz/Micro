
# 后端需求书 — MicroForum

> 注意：所有后端控制层必须使用 Servlet（`javax.servlet` / `jakarta.servlet` 对应 Tomcat 9 + Servlet 4.0），而非 Spring MVC。本设计面向直接使用 Servlet API 的项目。

## 一、总体说明
- **Servlet 版本**：4.0
- **容器**：Tomcat 9.0
- **Java 版本**：11+（建议 11）
- **数据库**：MySQL 8.x
- **连接池**：HikariCP（作为 DataSource）
- **配置**：`src/main/resources/application.properties`
- **Session 管理**：Tomcat HttpSession（cookie-based，HttpOnly）

## 二、包结构（强制）
```
com.microforum
 ├─ servlet         # 控制层：所有 HttpServlet（路径 /api/* 或 /app/*）
 ├─ service         # 业务逻辑
 ├─ dao             # 数据访问（JDBC + PreparedStatement）
 ├─ entity          # POJO 对应表
 ├─ util            # 公共工具（DBUtil, FileUtil, JSONUtil, PasswordUtil）
 ├─ filter          # 认证/跨域/日志过滤器
 ├─ listener        # 初始化资源（ContextListener）
 └─ exception       # 自定义异常
```

> 特别强调：`servlet` 包（非 `server`）。

## 三、核心实体（Java 字段与说明，位于 `com.microforum.entity`）

### User.java
```java
public class User {
    private long id;
    private String username;
    private String email;
    private String passwordHash;
    private String displayName;
    private String bio;
    private String avatarPath;
    private String role; // "USER" or "ADMIN"
    private boolean isBanned;
    private LocalDateTime createdAt;
    private LocalDateTime updatedAt;
    // getters/setters
}
```

### Post.java (简化)
```java
public class Post {
    private long id;
    private long userId;
    private String contentText;
    private String mediaMetaJson; // JSON string, array of media objects
    private String linkUrl;
    private String visibility; // PUBLIC/PRIVATE/FRIENDS
    private int likeCount;
    private int commentCount;
    private boolean isDeleted;
    private LocalDateTime createdAt;
    // getters/setters
}
```

其他实体：Media, Comment, Like, Follow（结构见数据库需求书）

## 四、DAO 设计（示例：UserDao 接口与实现）
- **接口**（`com.microforum.dao.UserDao`）
  - `Optional<User> findById(long id)`
  - `Optional<User> findByUsername(String username)`
  - `Optional<User> findByEmail(String email)`
  - `long create(User user)`  // 返回生成主键
  - `boolean update(User user)`
  - `boolean updatePassword(long userId, String passwordHash)`
  - `boolean setAvatar(long userId, String avatarPath)`
  - `List<User> list(int offset, int limit)`
  - `boolean banUser(long userId, boolean banned)`

- **实现类**（`com.microforum.dao.impl.UserDaoImpl`）
  - 使用 `DataSource`（HikariCP）注入（由 `ContextListener` 初始化）
  - 使用 `try-with-resources` 管理 Connection/PreparedStatement/ResultSet
  - 对日期采用 `TIMESTAMP` -> `LocalDateTime` 转换

#### UserDao.create() 伪代码
```java
String sql = "INSERT INTO users(username, email, password_hash, display_name, bio, avatar_path) VALUES (?,?,?,?,?,?)";
try (Connection c = ds.getConnection();
     PreparedStatement ps = c.prepareStatement(sql, Statement.RETURN_GENERATED_KEYS)) {
    ps.setString(1, user.getUsername());
    ...
    ps.executeUpdate();
    ResultSet rs = ps.getGeneratedKeys();
    if (rs.next()) return rs.getLong(1);
}
```

## 五、Servlet 控制层（`com.microforum.servlet`）—— 必须使用 HttpServlet，映射在 `web.xml` 或注解
- **AuthServlet** (`/api/auth/*`)
  - POST `/api/auth/register`：参数 `username,password,email?` -> 校验 -> 密码 BCrypt -> `userDao.create()` -> 返回 JSON `{success:true,userId:...}`
  - POST `/api/auth/login`：参数 `username,password` -> 读取 user -> BCrypt 校验 -> `request.getSession().setAttribute("user", userId)` -> 返回用户信息
  - POST `/api/auth/logout`：`request.getSession().invalidate()`

- **UserServlet** (`/api/users/*`)
  - GET `/api/users/{id}` -> 返回 User DTO（不含 passwordHash）
  - PUT `/api/users/{id}` -> 更新资料（需要 session 验证）
  - POST `/api/users/{id}/avatar` -> 处理 multipart 上传（使用 Servlet 3.0+ 的 `@MultipartConfig` 或 `request.getPart()`），保存到 file.storage.path，更新 avatarPath

- **PostServlet** (`/api/posts/*`)
  - GET `/api/posts` -> 支持 `feed=true`, `userId=`, `offset`, `limit`
  - GET `/api/posts/{id}` -> 详情
  - POST `/api/posts` -> 支持 multipart 或 JSON body（若有文件，建议先调用 MediaServlet 上传后再发 JSON）
  - DELETE `/api/posts/{id}` -> 软删除（作者或 ADMIN）
  - POST `/api/posts/{id}/like` -> 切换点赞（在 likes 表写/删并调整 posts.like_count）

- **MediaServlet** (`/api/media/upload`)
  - POST multipart 文件上传
  - 验证 MIME 类型（image/jpeg/png/webp, video/mp4 等），大小限制
  - 保存文件（见文件策略），返回 `{"path":"/uploads/2025/11/user_1/uuid.jpg","width":..,"height":..,"mime":"image/jpeg"}`

- **CommentServlet** (`/api/comments/*`)
  - POST -> 创建评论（字段：postId,parentCommentId?,content）
  - GET -> 通过 postId 获取评论列表（分页）

- **AdminServlet** (`/api/admin/*`)
  - 必须在 filter 中校验 role==ADMIN
  - 提供用户列表、内容列表、封禁/解封、删除帖子/评论接口

## 六、Filter 与 Listener
- **AuthFilter**
  - 过滤 `/api/*` 除了 `/api/auth/*` 的请求，检查 `request.getSession().getAttribute("user")` 是否存在，若不存在返回 `401 JSON` 或 redirect 到 login.jsp（根据请求类型判定）
- **CorsFilter**
  - 若需要跨域，设置 `Access-Control-Allow-*`
- **LoggingFilter**
  - 记录请求基本信息（method, path, duration）
- **AppContextListener**
  - 项目启动时初始化 DataSource（Hikari）、加载 `application.properties`、初始化 File storage 目录到 `ServletContext` 属性（`sc.setAttribute("FILE_STORAGE_PATH", path)`）

## 七、配置文件详情（`application.properties`）
```
# DB
db.url=jdbc:mysql://mysql:3306/microforum?useSSL=false&serverTimezone=UTC
db.user=micro_user
db.password=secure_password
db.pool.max=10

# File storage
file.storage.path=/data/microforum/uploads

# Upload limits
upload.maxFileSize=104857600  # 100MB
upload.maxRequestSize=209715200 # 200MB

# Security
bcrypt.workFactor=12
```

## 八、示例 Servlet 处理（PostServlet 创建帖子的执行步骤）
1. 前端（create_post.jsp）通过 JS 先上传媒体：`POST /api/media/upload`（multipart），得到 mediaMeta 列表（JSON）
2. 提交表单 `POST /api/posts`（Content-Type: application/json）包含 `contentText`, `mediaMeta`, `linkUrl`
3. PostServlet.doPost():
   - 验证 session，解析请求体 JSON（建议使用 Jackson 或 Gson）
   - 构造 Post 实体并调用 `postService.createPost(post, userId)`
4. PostService.createPost():
   - 调用 `postDao.create(post)`（JDBC 插入并返回 postId）
   - 若需要关联 media 表，插入 media 记录
   - 返回 postId
5. Servlet 返回 JSON `{ success:true, postId: 123 }`

## 九、错误处理与返回格式（统一）
- 成功：
```json
{ "success": true, "data": {...} }
```
- 失败：
```json
{ "success": false, "error": { "code": 4001, "message": "用户名已存在" } }
```
Servlet 层统一捕获异常并返回规范 JSON，勿直接抛出堆栈到客户端。

## 十、示例代码片段（MediaServlet - 上传）
```java
@MultipartConfig(fileSizeThreshold = 1024*1024, maxFileSize = 104857600L, maxRequestSize = 209715200L)
public class MediaServlet extends HttpServlet {
    protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        Part filePart = req.getPart("file");
        String contentType = filePart.getContentType();
        if (!isAllowed(contentType)) {
            resp.setStatus(HttpServletResponse.SC_BAD_REQUEST);
            resp.getWriter().write("{\"success\":false,\"error\":{\"message\":\"不支持的文件类型\"}}");
            return;
        }
        String storageRoot = getServletContext().getInitParameter("FILE_STORAGE_PATH");
        // 生成路径: /uploads/2025/11/user_<id>/uuid.ext
        String savedRelativePath = FileUtil.savePart(filePart, storageRoot, userId);
        // 返回 JSON
        resp.setContentType("application/json;charset=utf-8");
        resp.getWriter().write("{\"success\":true,\"path\":\"" + savedRelativePath + "\"}");
    }
}
```

## 十一、事务与回滚（手动）
- JDBC 模式下，若一次操作牵涉多张表（post + media），应在 Service 层获取 Connection 并手动管理事务（`conn.setAutoCommit(false)`），出现异常时 `rollback()` 并清理已保存文件。

## 十二、调试与本地运行
- 在 IDEA 中配置 Tomcat 9 运行，使用 `application.properties` 指向本地 MySQL（jdbc:mysql://localhost:3306/...）
- 断点调试 Servlet，使用 Postman 调试 `/api/*` 接口

## 十三、测试建议
- DAO 层使用测试 DB（独立），Service 层做单元测试（模拟 DataSource）
- 集成测试：在 CI 或本地使用 Docker Compose 启动 MySQL + Tomcat，然后运行集成测试脚本

