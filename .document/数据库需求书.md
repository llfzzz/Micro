
# 数据库需求书 — MicroForum

## 一、数据库准备（强制步骤）
1. 安装 MySQL 8（或使用 Docker 容器）
2. 登录 MySQL 创建库与用户（示例）
```sql
CREATE DATABASE microforum CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'micro_user'@'%' IDENTIFIED BY 'secure_password';
GRANT ALL PRIVILEGES ON microforum.* TO 'micro_user'@'%';
FLUSH PRIVILEGES;
```
3. 确认 `my.cnf` 中 `character-set-server=utf8mb4` 若使用容器则用环境变量

## 二、建表脚本（完整，含索引与约束）

### users 表
```sql
CREATE TABLE IF NOT EXISTS users (
  id BIGINT NOT NULL AUTO_INCREMENT PRIMARY KEY,
  username VARCHAR(50) NOT NULL UNIQUE,
  email VARCHAR(100),
  password_hash VARCHAR(255) NOT NULL,
  display_name VARCHAR(100),
  bio VARCHAR(500),
  avatar_path VARCHAR(255),
  role ENUM('USER','ADMIN') DEFAULT 'USER',
  is_banned TINYINT DEFAULT 0,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

### posts 表
```sql
CREATE TABLE IF NOT EXISTS posts (
  id BIGINT NOT NULL AUTO_INCREMENT PRIMARY KEY,
  user_id BIGINT NOT NULL,
  content_text TEXT,
  media_meta TEXT,
  link_url VARCHAR(2048),
  visibility ENUM('PUBLIC','PRIVATE','FRIENDS') DEFAULT 'PUBLIC',
  like_count INT DEFAULT 0,
  comment_count INT DEFAULT 0,
  forward_count INT DEFAULT 0,
  is_deleted TINYINT DEFAULT 0,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  INDEX idx_user_time (user_id, created_at),
  INDEX idx_time (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

### media 表
```sql
CREATE TABLE IF NOT EXISTS media (
  id BIGINT NOT NULL AUTO_INCREMENT PRIMARY KEY,
  post_id BIGINT,
  uploader_id BIGINT,
  type ENUM('IMAGE','VIDEO','OTHER'),
  path VARCHAR(1024),
  original_name VARCHAR(255),
  width INT,
  height INT,
  size BIGINT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (post_id) REFERENCES posts(id) ON DELETE CASCADE,
  FOREIGN KEY (uploader_id) REFERENCES users(id) ON DELETE SET NULL,
  INDEX idx_post (post_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

### comments 表
```sql
CREATE TABLE IF NOT EXISTS comments (
  id BIGINT NOT NULL AUTO_INCREMENT PRIMARY KEY,
  post_id BIGINT NOT NULL,
  user_id BIGINT NOT NULL,
  parent_comment_id BIGINT,
  content TEXT,
  is_deleted TINYINT DEFAULT 0,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (post_id) REFERENCES posts(id) ON DELETE CASCADE,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  INDEX idx_post (post_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

### likes 表
```sql
CREATE TABLE IF NOT EXISTS likes (
  id BIGINT NOT NULL AUTO_INCREMENT PRIMARY KEY,
  post_id BIGINT NOT NULL,
  user_id BIGINT NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UNIQUE KEY ux_like_user_post (post_id, user_id),
  FOREIGN KEY (post_id) REFERENCES posts(id) ON DELETE CASCADE,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  INDEX idx_post (post_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

### follows 表
```sql
CREATE TABLE IF NOT EXISTS follows (
  id BIGINT NOT NULL AUTO_INCREMENT PRIMARY KEY,
  follower_id BIGINT NOT NULL,
  followee_id BIGINT NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UNIQUE KEY ux_follow (follower_id, followee_id),
  FOREIGN KEY (follower_id) REFERENCES users(id) ON DELETE CASCADE,
  FOREIGN KEY (followee_id) REFERENCES users(id) ON DELETE CASCADE,
  INDEX idx_follower (follower_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

## 三、JDBC 连接详解（Tomcat Resource 建议）
- **推荐在 Tomcat 配置 DataSource（context.xml）**，示例（`META-INF/context.xml` 或 `$CATALINA_BASE/conf/context.xml`）：
```xml
<Resource name="jdbc/microforum" auth="Container" type="javax.sql.DataSource"
          maxTotal="20" maxIdle="10" maxWaitMillis="10000"
          username="micro_user" password="secure_password" driverClassName="com.mysql.cj.jdbc.Driver"
          url="jdbc:mysql://mysql:3306/microforum?useSSL=false&serverTimezone=UTC"/>
```
- Java 使用 JNDI 获取 DataSource：
```java
Context ctx = new InitialContext();
DataSource ds = (DataSource) ctx.lookup("java:comp/env/jdbc/microforum");
```

或者在 `AppContextListener` 中用 HikariCP 根据 `application.properties` 初始化并放入 ServletContext。

## 四、索引与查询优化建议
- 为 feed 查询：`SELECT ... FROM posts WHERE is_deleted=0 ORDER BY created_at DESC LIMIT ?,?`，确保 `created_at` 有索引
- 对大字段 `content_text` 不做全文索引；若需要搜索功能，后续引入 Elasticsearch 或 MySQL FULLTEXT（适配 utf8mb4）
- 对统计计数（like_count/comment_count）可用冗余字段以减少聚合

## 五、备份恢复（本地）
- 备份：
  - `mysqldump -u micro_user -p microforum > microforum_backup.sql`
- 恢复：
  - `mysql -u micro_user -p microforum < microforum_backup.sql`

## 六、迁移与环境区分
- 使用不同的 `application.properties`：`application-dev.properties`（本地），`application-prod.properties`（生产）
- 环境变量优先级高于属性文件（Docker Compose 可注入 env）

## 七、权限与安全注意
- 不在日志中输出敏感信息（如 password_hash）
- 对文件路径与 URL 使用白名单或正则校验以防目录遍历

